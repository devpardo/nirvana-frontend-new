webpackJsonp([36],{298:function(e,t,n){n(774);var a=n(5)(n(480),n(688),"data-v-062ee3c4",null);a.options.__file="/Users/bryanpardo/Development/nirvana-frontend/src/views/Message/ChatDetail.vue",a.esModule&&Object.keys(a.esModule).some(function(e){return"default"!==e&&"__esModule"!==e})&&console.error("named exports are not supported in *.vue files."),a.options.functional&&console.error("[vue-loader] ChatDetail.vue: functional components are not supported with templates, they should use render functions."),e.exports=a.exports},348:function(e,t,n){"use strict";function a(e,t){if(!e)return"";"string"==typeof e&&(e=new Date(e)),t=t||"yyyy-MM-dd HH:mm:ss";var n={year:e.getFullYear(),month:e.getMonth()+1,day:e.getDate(),hour:e.getHours(),minutes:e.getMinutes(),seconds:e.getSeconds()};for(var a in n){var s=n[a];s=s<10?"0"+s:s,n[a]=s.toString()}var i=n.year,r=n.month,o=n.day,c=n.hour,d=n.minutes,l=n.seconds;return t.replace(/y+/,function(e){return i.substring(i.length,-e.length)}).replace(/M+/,function(){return r}).replace(/d+/,function(){return o}).replace(/H+/,function(){return c}).replace(/h+/,function(){return c%12==0?12:c%12}).replace(/m+/,function(){return d}).replace(/s+/,function(){return l})}n(0).default.filter("date",a)},480:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=n(30),s=n.n(a),i=n(25),r=n.n(i),o=n(0),c=(n(348),n(26));t.default={data:function(){return{topStatus:"",onlineCustomers:[],currentCustomer:null,userAvatar:this.$store.state.user.aws_url,chatContent:"",chatLines:[],query:{page:0,per_page:10},chatLinePaginateMeta:null}},computed:r()({},n.i(c.b)({currentChat:function(e){return e.chat.currentChat},cable:function(e){return e.chat.cable}}),{noMoreMessages:function(){return this.chatLinePaginateMeta&&(this.chatLinePaginateMeta.total_pages===this.query.page||0===this.chatLinePaginateMeta.total_pages)},chatLoading:function(){return!this.noMoreMessages}}),watch:{onlineCustomers:function(e){this.updateChatAdmin()},currentChat:function(e,t){e&&!t&&(this.updateChatAdmin(),this.fetchNexPageChatLine(),this.$store.dispatch("makeAllChatMessageRead"))}},methods:{fetchChat:function(){var e=this;this.api.getOwnChat().then(function(t){e.currentChat=t.data,e.fetchNexPageChatLine()})},fetchOnlineAdmins:function(){var e=this;this.api.getOnlineCustomers().then(function(t){e.onlineCustomers=t.data.customers})},fetchNexPageChatLine:function(){var e=this;this.query.page+=1,this.api.getChatLines(this.currentChat.id,this.query).then(function(t){if(e.chatLinePaginateMeta=t.data.paginate_meta,e.chatLines=t.data.chat_lines.reverse().concatUniq(e.chatLines,"id"),e.$refs.loadmore.onTopLoaded(),e.$nextTick(function(){e.focus()}),1===e.query.page){var n=e,a=e.$route.query;e.ory=e.cable.subscriptions.create({channel:"ChatLinesChannel",chat_id:n.currentChat.id},{connected:function(){var e=this;a&&a.type&&setTimeout(function(){e.sendMessage(s()({type:a.type,typeId:a.typeId}),"cate_object")},1e3)},received:function(e){n.chatLines.push(e),this.mark_chat_line_read(e)},sendMessage:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"cate_text";this.perform("send_message",{message:e,cate:t,chat_id:n.currentChat.id,receiver_id:n.currentChat.user_id})},mark_chat_line_read:function(e){this.perform("mark_chat_line_read",{chat_line_id:e.id})}})}})},handleSentMessage:function(){if(this.chatContent.match(/^\s*$/))return void this.$toast({message:"不能发送空白消息",position:"middle",duration:5e3});this.ory&&this.ory.sendMessage(this.chatContent),this.chatContent=""},handleTopChange:function(e){this.topStatus=e},isSelf:function(e){return e.sender_id===this.currentChat.user.id},loadTop:function(){if(this.noMoreMessages)return void this.$refs.loadmore.onTopLoaded();this.fetchNexPageChatLine()},focus:function(){document.getElementById("scroll").scrollIntoView(!0)},updateChatAdmin:function(){var e=this;if(this.currentChat&&this.onlineCustomers.length){var t=!1;if(this.onlineCustomers.forEach(function(n){n.id===e.currentChat.admin_id&&(e.currentCustomer=n,t=!0)}),!t){var n=parseInt(Math.random()*this.onlineCustomers.length),a=this.onlineCustomers[n];this.api.updateChatInfo({admin_id:a.id}).then(function(t){e.currentCustomer=a})}}}},mounted:function(){var e={navigateTitle:!1};this.$store.dispatch("setNavigationTitle",e),this.currentChat&&(this.fetchNexPageChatLine(),this.$store.dispatch("makeAllChatMessageRead")),this.fetchOnlineAdmins()},beforeDestroy:function(){this.cable.subscriptions.remove(this.ory)},directives:{scroll:{componentUpdated:function(e){o.default.nextTick(function(){e.scrollHeight-e.scrollTop-e.clientHeight<300&&document.getElementById("scroll").scrollIntoView(!0)})}}}}},524:function(e,t,n){t=e.exports=n(1)(),t.push([e.i,".dl[data-v-062ee3c4] {\n  display: inline-block;\n}\n\n.body[data-v-062ee3c4] {\n  padding: 0.266667rem;\n  top: 1.333333rem;\n  left: 0;\n  right: 0;\n  bottom: 1.333333rem;\n  position: absolute;\n  padding-bottom: 1.386667rem;\n  overflow: scroll;\n}\n\n.loading[data-v-062ee3c4] {\n  display: inline-block;\n  position: relative;\n  top: 1.333333rem;\n}\n\n.message[data-v-062ee3c4] {\n  margin: 0.266667rem;\n  text-align: justify;\n}\n\n.message .img[data-v-062ee3c4] {\n  display: inline-block;\n  width: 1.066667rem;\n  height: 1.066667rem;\n  vertical-align: top;\n}\n\n.message .bg-fl[data-v-062ee3c4] {\n  background-color: #ffffff;\n}\n\n.message .bg-fr[data-v-062ee3c4] {\n  background-color: #F6A623;\n  right: 0.133333rem;\n}\n\n.message .txt[data-v-062ee3c4] {\n  margin: 0 0.266667rem;\n  position: relative;\n  display: inline-block;\n  padding: 0.266667rem;\n  max-width: 6.8rem;\n  font-size: 0.373333rem;\n  padding: 0.266667rem;\n  border-radius: 0.133333rem;\n  line-height: 1.2em;\n  word-wrap: break-word;\n}\n\n.arrow_left[data-v-062ee3c4] {\n  position: absolute;\n  top: 10%;\n  left: -0.186667rem;\n  width: 0;\n  height: 0;\n  border-width: 0.213333rem 0.213333rem 0.213333rem 0;\n  border-style: solid;\n  border-color: transparent #ffffff transparent transparent;\n}\n\n.arrow_right[data-v-062ee3c4] {\n  position: absolute;\n  top: 10%;\n  right: -0.186667rem;\n  width: 0;\n  height: 0;\n  border-width: 0.213333rem 0 0.213333rem 0.213333rem;\n  border-style: solid;\n  border-color: transparent transparent transparent #F6A623;\n}\n\n.chat-input[data-v-062ee3c4] {\n  height: 1.333333rem;\n  padding: 0.133333rem 0.266667rem;\n}\n\n.chat-input input[data-v-062ee3c4] {\n  border: 0.032rem solid #efefef;\n  outline: none;\n  width: 82%;\n  height: 100%;\n}\n\n.chat-input .send[data-v-062ee3c4] {\n  padding: 0.213333rem;\n  background-color: #F6A623;\n  color: #ffffff;\n  border-radius: 0.133333rem;\n  letter-spacing: 0.08rem;\n  font-size: 0.373333rem;\n  height: initial;\n  border: none;\n}\n\n.fixed[data-v-062ee3c4] {\n  position: fixed;\n  bottom: 1.44rem;\n  right: 0;\n  left: 0;\n  z-index: 100;\n  background-color: #ffffff;\n}\n\n.load-position[data-v-062ee3c4] {\n  display: block;\n  position: relative;\n  left: 45%;\n}\n\n.chat-date[data-v-062ee3c4] {\n  background-color: #d8d8d8;\n  color: #ffffff;\n  display: block;\n  max-width: 5.333333rem;\n  padding: 0.053333rem 0.133333rem;\n  text-align: center;\n  border-radius: 0.08rem;\n}\n\n.fl-bottom[data-v-062ee3c4] {\n  margin-bottom: 0.133333rem;\n}\n\n.fr-bottom[data-v-062ee3c4] {\n  margin-bottom: 0.266667rem;\n}\n\n.chat-name[data-v-062ee3c4] {\n  display: block;\n  text-align: left;\n  padding: 0.133333rem;\n  padding-top: 0;\n}",""])},688:function(e,t,n){e.exports={render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"scroll",rawName:"v-scroll",value:e.chatLines,expression:"chatLines"}],staticClass:"body"},[n("mt-loadmore",{ref:"loadmore",attrs:{"top-method":e.loadTop},on:{"top-status-change":e.handleTopChange}},[e._l(e.chatLines,function(t){return"cate_object"!=t.cate?n("div",{staticStyle:{overflow:"hidden"}},[e.isSelf(t)?n("div",{staticClass:"message fr"},[n("span",{staticClass:"chat-date fr-bottom fr"},[e._v(e._s(e._f("date")(t.created_at,"yyy-MM-dd HH:mm:ss")))]),e._v(" "),n("span",{staticClass:"img fr clearfix"},[n("img",{directives:[{name:"lazy",rawName:"v-lazy",value:e.userAvatar,expression:"userAvatar"}],attrs:{width:"100%",height:"100%"}})]),e._v(" "),n("p",{staticClass:"txt bg-fr fr"},[e._v(e._s(t.content||"[]")),n("span",{staticClass:"arrow_right"})])]):n("div",{staticClass:"message fl"},[n("span",{staticClass:"chat-date fl-bottom"},[e._v(e._s(e._f("date")(t.created_at,"yyy-MM-dd HH:mm:ss")))]),e._v(" "),n("span",{staticClass:"chat-name"},[e._v(e._s(t.sender&&t.sender.nickname))]),e._v(" "),n("span",{staticClass:"img"},[n("img",{directives:[{name:"lazy",rawName:"v-lazy",value:t.sender&&t.sender.aws_url,expression:"message.sender && message.sender.aws_url"}],attrs:{width:"100%",height:"100%"}})]),e._v(" "),n("p",{staticClass:"txt bg-fl"},[e._v(e._s(t.content||"[]")),n("span",{staticClass:"arrow_left"})])])]):e._e()}),e._v(" "),n("div",{staticClass:"mint-loadmore-top",slot:"top"},[e.noMoreMessages?e._e():n("div",[n("span",{directives:[{name:"show",rawName:"v-show",value:"loading"!==e.topStatus,expression:"topStatus !== 'loading'"}],class:{rotate:"drop"===e.topStatus}},[e._v("↓")]),e._v(" "),n("span",{directives:[{name:"show",rawName:"v-show",value:"loading"===e.topStatus,expression:"topStatus === 'loading'"}]},[e._v("History loading...")])]),e._v(" "),e.noMoreMessages?n("span",[e._v("无更多历史记录")]):e._e()])],2),e._v(" "),n("div",{staticClass:"clearfix",attrs:{id:"scroll"}}),e._v(" "),n("div",{staticClass:"clearfix chat-input fixed",attrs:{id:"input"}},[n("input",{directives:[{name:"model",rawName:"v-model",value:e.chatContent,expression:"chatContent"}],staticClass:"dl",attrs:{type:"text"},domProps:{value:e.chatContent},on:{click:function(t){e.focus()},input:function(t){t.target.composing||(e.chatContent=t.target.value)}}}),e._v(" "),n("mt-button",{staticClass:"dl send",attrs:{disabled:!e.currentChat||!e.currentCustomer},on:{click:e.handleSentMessage}},[e._v("发送")])],1)],1)},staticRenderFns:[]},e.exports.render._withStripped=!0},774:function(e,t,n){var a=n(524);"string"==typeof a&&(a=[[e.i,a,""]]),a.locals&&(e.exports=a.locals);n(2)("0f675060",a,!1)}});